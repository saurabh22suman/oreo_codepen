# ==================================
# Oreo CodePen - Production Configuration
# ==================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --build -d
#
# Features:
#   - Optimized production build
#   - Non-root user execution
#   - Health checks enabled
#   - Resource limits
#   - Logging configuration

services:
  oreo-app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    
    image: oreo-codepen:prod
    container_name: oreo-codepen-prod
    
    ports:
      - "${PORT:-3000}:3000"
    
    environment:
      - NODE_ENV=production
    
    # Resource limits for stability
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (projects dir is mounted as writable)
    read_only: true
    tmpfs:
      - /tmp
    
    # Ensure volumes are properly mounted for production
    volumes:
      - oreo-projects:/app/projects
      - oreo-metadata:/app/metadata

# Named volumes for data persistence
volumes:
  oreo-projects:
    driver: local
  oreo-metadata:
    driver: local
